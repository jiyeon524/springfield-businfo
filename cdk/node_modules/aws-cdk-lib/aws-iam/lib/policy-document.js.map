{
  "version": 3,
  "sources": ["policy-document.ts"],
  "sourcesContent": ["import * as cdk from '../../core';\nimport { PolicyStatement } from './policy-statement';\n\n/**\n * Properties for a new PolicyDocument\n */\nexport interface PolicyDocumentProps {\n  /**\n   * Automatically assign Statement Ids to all statements\n   *\n   * @default false\n   */\n  readonly assignSids?: boolean;\n\n  /**\n   * Initial statements to add to the policy document\n   *\n   * @default - No statements\n   */\n  readonly statements?: PolicyStatement[];\n}\n\n/**\n * A PolicyDocument is a collection of statements\n */\nexport class PolicyDocument implements cdk.IResolvable {\n\n  /**\n   * Creates a new PolicyDocument based on the object provided.\n   * This will accept an object created from the `.toJSON()` call\n   * @param obj the PolicyDocument in object form.\n   */\n  public static fromJson(obj: any): PolicyDocument {\n    const newPolicyDocument = new PolicyDocument();\n    const statement = obj.Statement ?? [];\n    if (statement && !Array.isArray(statement)) {\n      throw new Error('Statement must be an array');\n    }\n    newPolicyDocument.addStatements(...obj.Statement.map((s: any) => PolicyStatement.fromJson(s)));\n    return newPolicyDocument;\n  }\n\n  public readonly creationStack: string[];\n  private readonly statements = new Array<PolicyStatement>();\n  private readonly autoAssignSids: boolean;\n\n  constructor(props: PolicyDocumentProps = {}) {\n    this.creationStack = cdk.captureStackTrace();\n    this.autoAssignSids = !!props.assignSids;\n\n    this.addStatements(...props.statements || []);\n  }\n\n  public resolve(context: cdk.IResolveContext): any {\n    context.registerPostProcessor(new RemoveDuplicateStatements(this.autoAssignSids));\n    return this.render();\n  }\n\n  /**\n   * Whether the policy document contains any statements.\n   */\n  public get isEmpty(): boolean {\n    return this.statements.length === 0;\n  }\n\n  /**\n   * The number of statements already added to this policy.\n   * Can be used, for example, to generate unique \"sid\"s within the policy.\n   */\n  public get statementCount(): number {\n    return this.statements.length;\n  }\n\n  /**\n   * Adds a statement to the policy document.\n   *\n   * @param statement the statement to add.\n   */\n  public addStatements(...statement: PolicyStatement[]) {\n    this.statements.push(...statement);\n  }\n\n  /**\n   * Encode the policy document as a string\n   */\n  public toString() {\n    return cdk.Token.asString(this, {\n      displayHint: 'PolicyDocument',\n    });\n  }\n\n  /**\n   * JSON-ify the document\n   *\n   * Used when JSON.stringify() is called\n   */\n  public toJSON() {\n    return this.render();\n  }\n\n  /**\n   * Validate that all policy statements in the policy document satisfies the\n   * requirements for any policy.\n   *\n   * @see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html#access_policies-json\n   */\n  public validateForAnyPolicy(): string[] {\n    const errors = new Array<string>();\n    for (const statement of this.statements) {\n      errors.push(...statement.validateForAnyPolicy());\n    }\n    return errors;\n  }\n\n  /**\n   * Validate that all policy statements in the policy document satisfies the\n   * requirements for a resource-based policy.\n   *\n   * @see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html#access_policies-json\n   */\n  public validateForResourcePolicy(): string[] {\n    const errors = new Array<string>();\n    for (const statement of this.statements) {\n      errors.push(...statement.validateForResourcePolicy());\n    }\n    return errors;\n  }\n\n  /**\n   * Validate that all policy statements in the policy document satisfies the\n   * requirements for an identity-based policy.\n   *\n   * @see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html#access_policies-json\n   */\n  public validateForIdentityPolicy(): string[] {\n    const errors = new Array<string>();\n    for (const statement of this.statements) {\n      errors.push(...statement.validateForIdentityPolicy());\n    }\n    return errors;\n  }\n\n  private render(): any {\n    if (this.isEmpty) {\n      return undefined;\n    }\n\n    const doc = {\n      Statement: this.statements.map(s => s.toStatementJson()),\n      Version: '2012-10-17',\n    };\n\n    return doc;\n  }\n}\n\n/**\n * Removes duplicate statements and assign Sids if necessary\n */\nclass RemoveDuplicateStatements implements cdk.IPostProcessor {\n  constructor(private readonly autoAssignSids: boolean) {\n  }\n\n  public postProcess(input: any, _context: cdk.IResolveContext): any {\n    if (!input || !input.Statement) {\n      return input;\n    }\n\n    const jsonStatements = new Set<string>();\n    const uniqueStatements: any[] = [];\n\n    for (const statement of input.Statement) {\n      const jsonStatement = JSON.stringify(statement);\n      if (!jsonStatements.has(jsonStatement)) {\n        uniqueStatements.push(statement);\n        jsonStatements.add(jsonStatement);\n      }\n    }\n\n    // assign unique SIDs (the statement index) if `autoAssignSids` is enabled\n    const statements = uniqueStatements.map((s, i) => {\n      if (this.autoAssignSids && !s.Sid) {\n        s.Sid = i.toString();\n      }\n\n      return s;\n    });\n\n    return {\n      ...input,\n      Statement: statements,\n    };\n  }\n}\n"],
  "mappings": "qNAAA,IAAA,QAAA,YAAA,EACA,mBAAA,QAAA,oBAAA,EAwBA,MAAa,cAAc,CAqBzB,YAAY,MAA6B,CAAA,EAAE,CAH1B,KAAA,WAAa,GAAI,8EAIhC,KAAK,cAAgB,IAAI,kBAAiB,EAC1C,KAAK,eAAiB,CAAC,CAAC,MAAM,WAE9B,KAAK,cAAc,GAAG,MAAM,YAAc,CAAA,CAAE,QAlBhC,UAAS,IAAQ,QAC7B,KAAM,mBAAoB,GAAI,gBACxB,UAAS,IAAG,IAAI,aAAS,MAAA,KAAA,OAAA,GAAI,CAAA,EACnC,GAAI,WAAa,CAAC,MAAM,QAAQ,SAAS,EACvC,KAAM,IAAI,OAAM,4BAA4B,EAE9C,yBAAkB,cAAc,GAAG,IAAI,UAAU,IAAI,AAAC,GAAW,mBAAA,gBAAgB,SAAS,CAAC,CAAC,CAAC,EACtF,kBAcF,QAAQ,QAA4B,qEACzC,QAAQ,sBAAsB,GAAI,2BAA0B,KAAK,cAAc,CAAC,EACzE,KAAK,OAAM,KAMT,UAAO,CAChB,MAAO,MAAK,WAAW,SAAW,KAOzB,iBAAc,CACvB,MAAO,MAAK,WAAW,OAQlB,iBAAiB,UAA4B,wEAClD,KAAK,WAAW,KAAK,GAAG,SAAS,EAM5B,UAAQ,CACb,MAAO,KAAI,MAAM,SAAS,KAAM,CAC9B,YAAa,iBACd,EAQI,QAAM,CACX,MAAO,MAAK,OAAM,EASb,sBAAoB,CACzB,KAAM,QAAS,GAAI,OACnB,SAAW,aAAa,MAAK,WAC3B,OAAO,KAAK,GAAG,UAAU,qBAAoB,CAAE,EAEjD,MAAO,QASF,2BAAyB,CAC9B,KAAM,QAAS,GAAI,OACnB,SAAW,aAAa,MAAK,WAC3B,OAAO,KAAK,GAAG,UAAU,0BAAyB,CAAE,EAEtD,MAAO,QASF,2BAAyB,CAC9B,KAAM,QAAS,GAAI,OACnB,SAAW,aAAa,MAAK,WAC3B,OAAO,KAAK,GAAG,UAAU,0BAAyB,CAAE,EAEtD,MAAO,QAGD,QAAM,CACZ,MAAI,MAAK,QACP,OAGU,CACV,UAAW,KAAK,WAAW,IAAI,GAAK,EAAE,gBAAe,CAAE,EACvD,QAAS,eA5Hf,QAAA,eAAA,oHAsIA,MAAM,yBAAyB,CAC7B,YAA6B,eAAuB,CAAvB,KAAA,eAAA,eAGtB,YAAY,MAAY,SAA6B,CAC1D,GAAI,CAAC,OAAS,CAAC,MAAM,UACnB,MAAO,OAGT,KAAM,gBAAiB,GAAI,KACrB,iBAA0B,CAAA,EAEhC,SAAW,aAAa,OAAM,UAAW,CACvC,KAAM,eAAgB,KAAK,UAAU,SAAS,EAC9C,AAAK,eAAe,IAAI,aAAa,GACnC,kBAAiB,KAAK,SAAS,EAC/B,eAAe,IAAI,aAAa,GAKpC,KAAM,YAAa,iBAAiB,IAAI,CAAC,EAAG,IACtC,MAAK,gBAAkB,CAAC,EAAE,KAC5B,GAAE,IAAM,EAAE,SAAQ,GAGb,EACR,EAED,MAAO,IACF,MACH,UAAW",
  "names": []
}

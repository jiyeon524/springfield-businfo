"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isHotswappableAppSyncChange = void 0;
const common_1 = require("./common");
async function isHotswappableAppSyncChange(logicalId, change, evaluateCfnTemplate) {
    const isResolver = change.newValue.Type === 'AWS::AppSync::Resolver';
    const isFunction = change.newValue.Type === 'AWS::AppSync::FunctionConfiguration';
    if (!isResolver && !isFunction) {
        return common_1.ChangeHotswapImpact.REQUIRES_FULL_DEPLOYMENT;
    }
    for (const updatedPropName in change.propertyUpdates) {
        if (updatedPropName !== 'RequestMappingTemplate' && updatedPropName !== 'ResponseMappingTemplate') {
            return common_1.ChangeHotswapImpact.REQUIRES_FULL_DEPLOYMENT;
        }
    }
    const resourceProperties = change.newValue.Properties;
    if (isResolver && (resourceProperties === null || resourceProperties === void 0 ? void 0 : resourceProperties.Kind) === 'PIPELINE') {
        // Pipeline resolvers can't be hotswapped as they reference
        // the FunctionId of the underlying functions, which can't be resolved.
        return common_1.ChangeHotswapImpact.REQUIRES_FULL_DEPLOYMENT;
    }
    const resourcePhysicalName = await evaluateCfnTemplate.establishResourcePhysicalName(logicalId, isFunction ? resourceProperties === null || resourceProperties === void 0 ? void 0 : resourceProperties.Name : undefined);
    if (!resourcePhysicalName) {
        return common_1.ChangeHotswapImpact.REQUIRES_FULL_DEPLOYMENT;
    }
    const evaluatedResourceProperties = await evaluateCfnTemplate.evaluateCfnExpression(resourceProperties);
    const sdkCompatibleResourceProperties = common_1.transformObjectKeys(evaluatedResourceProperties, common_1.lowerCaseFirstCharacter);
    if (isResolver) {
        // Resolver physical name is the ARN in the format:
        // arn:aws:appsync:us-east-1:111111111111:apis/<apiId>/types/<type>/resolvers/<field>.
        // We'll use `<type>.<field>` as the resolver name.
        const arnParts = resourcePhysicalName.split('/');
        const resolverName = `${arnParts[3]}.${arnParts[5]}`;
        return new ResolverHotswapOperation(resolverName, sdkCompatibleResourceProperties);
    }
    else {
        return new FunctionHotswapOperation(resourcePhysicalName, sdkCompatibleResourceProperties);
    }
}
exports.isHotswappableAppSyncChange = isHotswappableAppSyncChange;
class ResolverHotswapOperation {
    constructor(resolverName, updateResolverRequest) {
        this.updateResolverRequest = updateResolverRequest;
        this.service = 'appsync';
        this.resourceNames = [`AppSync resolver '${resolverName}'`];
    }
    async apply(sdk) {
        return sdk.appsync().updateResolver(this.updateResolverRequest).promise();
    }
}
class FunctionHotswapOperation {
    constructor(functionName, updateFunctionRequest) {
        this.functionName = functionName;
        this.updateFunctionRequest = updateFunctionRequest;
        this.service = 'appsync';
        this.resourceNames = [`AppSync function '${functionName}'`];
    }
    async apply(sdk) {
        var _a;
        const { functions } = await sdk.appsync().listFunctions({ apiId: this.updateFunctionRequest.apiId }).promise();
        const { functionId } = (_a = functions === null || functions === void 0 ? void 0 : functions.find(fn => fn.name === this.functionName)) !== null && _a !== void 0 ? _a : {};
        const request = {
            ...this.updateFunctionRequest,
            functionId: functionId,
        };
        return sdk.appsync().updateFunction(request).promise();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1tYXBwaW5nLXRlbXBsYXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcHN5bmMtbWFwcGluZy10ZW1wbGF0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0EscUNBQWlLO0FBRTFKLEtBQUssVUFBVSwyQkFBMkIsQ0FDL0MsU0FBaUIsRUFBRSxNQUFtQyxFQUFFLG1CQUFtRDtJQUUzRyxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyx3QkFBd0IsQ0FBQztJQUNyRSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxxQ0FBcUMsQ0FBQztJQUVsRixJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsVUFBVSxFQUFFO1FBQzlCLE9BQU8sNEJBQW1CLENBQUMsd0JBQXdCLENBQUM7S0FDckQ7SUFFRCxLQUFLLE1BQU0sZUFBZSxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUU7UUFDcEQsSUFBSSxlQUFlLEtBQUssd0JBQXdCLElBQUksZUFBZSxLQUFLLHlCQUF5QixFQUFFO1lBQ2pHLE9BQU8sNEJBQW1CLENBQUMsd0JBQXdCLENBQUM7U0FDckQ7S0FDRjtJQUVELE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUM7SUFDdEQsSUFBSSxVQUFVLElBQUksQ0FBQSxrQkFBa0IsYUFBbEIsa0JBQWtCLHVCQUFsQixrQkFBa0IsQ0FBRSxJQUFJLE1BQUssVUFBVSxFQUFFO1FBQ3pELDJEQUEyRDtRQUMzRCx1RUFBdUU7UUFDdkUsT0FBTyw0QkFBbUIsQ0FBQyx3QkFBd0IsQ0FBQztLQUNyRDtJQUVELE1BQU0sb0JBQW9CLEdBQUcsTUFBTSxtQkFBbUIsQ0FBQyw2QkFBNkIsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsYUFBbEIsa0JBQWtCLHVCQUFsQixrQkFBa0IsQ0FBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ25KLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtRQUN6QixPQUFPLDRCQUFtQixDQUFDLHdCQUF3QixDQUFDO0tBQ3JEO0lBRUQsTUFBTSwyQkFBMkIsR0FBRyxNQUFNLG1CQUFtQixDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDeEcsTUFBTSwrQkFBK0IsR0FBRyw0QkFBbUIsQ0FBQywyQkFBMkIsRUFBRSxnQ0FBdUIsQ0FBQyxDQUFDO0lBRWxILElBQUksVUFBVSxFQUFFO1FBQ2QsbURBQW1EO1FBQ25ELHNGQUFzRjtRQUN0RixtREFBbUQ7UUFDbkQsTUFBTSxRQUFRLEdBQUcsb0JBQW9CLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sWUFBWSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3JELE9BQU8sSUFBSSx3QkFBd0IsQ0FBQyxZQUFZLEVBQUUsK0JBQStCLENBQUMsQ0FBQztLQUNwRjtTQUFNO1FBQ0wsT0FBTyxJQUFJLHdCQUF3QixDQUFDLG9CQUFvQixFQUFFLCtCQUErQixDQUFDLENBQUM7S0FDNUY7QUFDSCxDQUFDO0FBekNELGtFQXlDQztBQUVELE1BQU0sd0JBQXdCO0lBSTVCLFlBQVksWUFBb0IsRUFBbUIscUJBQXdEO1FBQXhELDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBbUM7UUFIM0YsWUFBTyxHQUFHLFNBQVMsQ0FBQTtRQUlqQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMscUJBQXFCLFlBQVksR0FBRyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBUztRQUMxQixPQUFPLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDNUUsQ0FBQztDQUNGO0FBRUQsTUFBTSx3QkFBd0I7SUFJNUIsWUFDbUIsWUFBb0IsRUFDcEIscUJBQTRFO1FBRDVFLGlCQUFZLEdBQVosWUFBWSxDQUFRO1FBQ3BCLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUQ7UUFML0UsWUFBTyxHQUFHLFNBQVMsQ0FBQTtRQU9qQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMscUJBQXFCLFlBQVksR0FBRyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBUzs7UUFDMUIsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMvRyxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQUcsU0FBUyxhQUFULFNBQVMsdUJBQVQsU0FBUyxDQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLFlBQVksb0NBQUssRUFBRSxDQUFDO1FBQ2xGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsR0FBRyxJQUFJLENBQUMscUJBQXFCO1lBQzdCLFVBQVUsRUFBRSxVQUFXO1NBQ3hCLENBQUM7UUFDRixPQUFPLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDekQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0IHsgSVNESyB9IGZyb20gJy4uL2F3cy1hdXRoJztcbmltcG9ydCB7IEV2YWx1YXRlQ2xvdWRGb3JtYXRpb25UZW1wbGF0ZSB9IGZyb20gJy4uL2V2YWx1YXRlLWNsb3VkZm9ybWF0aW9uLXRlbXBsYXRlJztcbmltcG9ydCB7IENoYW5nZUhvdHN3YXBJbXBhY3QsIENoYW5nZUhvdHN3YXBSZXN1bHQsIEhvdHN3YXBPcGVyYXRpb24sIEhvdHN3YXBwYWJsZUNoYW5nZUNhbmRpZGF0ZSwgbG93ZXJDYXNlRmlyc3RDaGFyYWN0ZXIsIHRyYW5zZm9ybU9iamVjdEtleXMgfSBmcm9tICcuL2NvbW1vbic7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBpc0hvdHN3YXBwYWJsZUFwcFN5bmNDaGFuZ2UoXG4gIGxvZ2ljYWxJZDogc3RyaW5nLCBjaGFuZ2U6IEhvdHN3YXBwYWJsZUNoYW5nZUNhbmRpZGF0ZSwgZXZhbHVhdGVDZm5UZW1wbGF0ZTogRXZhbHVhdGVDbG91ZEZvcm1hdGlvblRlbXBsYXRlLFxuKTogUHJvbWlzZTxDaGFuZ2VIb3Rzd2FwUmVzdWx0PiB7XG4gIGNvbnN0IGlzUmVzb2x2ZXIgPSBjaGFuZ2UubmV3VmFsdWUuVHlwZSA9PT0gJ0FXUzo6QXBwU3luYzo6UmVzb2x2ZXInO1xuICBjb25zdCBpc0Z1bmN0aW9uID0gY2hhbmdlLm5ld1ZhbHVlLlR5cGUgPT09ICdBV1M6OkFwcFN5bmM6OkZ1bmN0aW9uQ29uZmlndXJhdGlvbic7XG5cbiAgaWYgKCFpc1Jlc29sdmVyICYmICFpc0Z1bmN0aW9uKSB7XG4gICAgcmV0dXJuIENoYW5nZUhvdHN3YXBJbXBhY3QuUkVRVUlSRVNfRlVMTF9ERVBMT1lNRU5UO1xuICB9XG5cbiAgZm9yIChjb25zdCB1cGRhdGVkUHJvcE5hbWUgaW4gY2hhbmdlLnByb3BlcnR5VXBkYXRlcykge1xuICAgIGlmICh1cGRhdGVkUHJvcE5hbWUgIT09ICdSZXF1ZXN0TWFwcGluZ1RlbXBsYXRlJyAmJiB1cGRhdGVkUHJvcE5hbWUgIT09ICdSZXNwb25zZU1hcHBpbmdUZW1wbGF0ZScpIHtcbiAgICAgIHJldHVybiBDaGFuZ2VIb3Rzd2FwSW1wYWN0LlJFUVVJUkVTX0ZVTExfREVQTE9ZTUVOVDtcbiAgICB9XG4gIH1cblxuICBjb25zdCByZXNvdXJjZVByb3BlcnRpZXMgPSBjaGFuZ2UubmV3VmFsdWUuUHJvcGVydGllcztcbiAgaWYgKGlzUmVzb2x2ZXIgJiYgcmVzb3VyY2VQcm9wZXJ0aWVzPy5LaW5kID09PSAnUElQRUxJTkUnKSB7XG4gICAgLy8gUGlwZWxpbmUgcmVzb2x2ZXJzIGNhbid0IGJlIGhvdHN3YXBwZWQgYXMgdGhleSByZWZlcmVuY2VcbiAgICAvLyB0aGUgRnVuY3Rpb25JZCBvZiB0aGUgdW5kZXJseWluZyBmdW5jdGlvbnMsIHdoaWNoIGNhbid0IGJlIHJlc29sdmVkLlxuICAgIHJldHVybiBDaGFuZ2VIb3Rzd2FwSW1wYWN0LlJFUVVJUkVTX0ZVTExfREVQTE9ZTUVOVDtcbiAgfVxuXG4gIGNvbnN0IHJlc291cmNlUGh5c2ljYWxOYW1lID0gYXdhaXQgZXZhbHVhdGVDZm5UZW1wbGF0ZS5lc3RhYmxpc2hSZXNvdXJjZVBoeXNpY2FsTmFtZShsb2dpY2FsSWQsIGlzRnVuY3Rpb24gPyByZXNvdXJjZVByb3BlcnRpZXM/Lk5hbWUgOiB1bmRlZmluZWQpO1xuICBpZiAoIXJlc291cmNlUGh5c2ljYWxOYW1lKSB7XG4gICAgcmV0dXJuIENoYW5nZUhvdHN3YXBJbXBhY3QuUkVRVUlSRVNfRlVMTF9ERVBMT1lNRU5UO1xuICB9XG5cbiAgY29uc3QgZXZhbHVhdGVkUmVzb3VyY2VQcm9wZXJ0aWVzID0gYXdhaXQgZXZhbHVhdGVDZm5UZW1wbGF0ZS5ldmFsdWF0ZUNmbkV4cHJlc3Npb24ocmVzb3VyY2VQcm9wZXJ0aWVzKTtcbiAgY29uc3Qgc2RrQ29tcGF0aWJsZVJlc291cmNlUHJvcGVydGllcyA9IHRyYW5zZm9ybU9iamVjdEtleXMoZXZhbHVhdGVkUmVzb3VyY2VQcm9wZXJ0aWVzLCBsb3dlckNhc2VGaXJzdENoYXJhY3Rlcik7XG5cbiAgaWYgKGlzUmVzb2x2ZXIpIHtcbiAgICAvLyBSZXNvbHZlciBwaHlzaWNhbCBuYW1lIGlzIHRoZSBBUk4gaW4gdGhlIGZvcm1hdDpcbiAgICAvLyBhcm46YXdzOmFwcHN5bmM6dXMtZWFzdC0xOjExMTExMTExMTExMTphcGlzLzxhcGlJZD4vdHlwZXMvPHR5cGU+L3Jlc29sdmVycy88ZmllbGQ+LlxuICAgIC8vIFdlJ2xsIHVzZSBgPHR5cGU+LjxmaWVsZD5gIGFzIHRoZSByZXNvbHZlciBuYW1lLlxuICAgIGNvbnN0IGFyblBhcnRzID0gcmVzb3VyY2VQaHlzaWNhbE5hbWUuc3BsaXQoJy8nKTtcbiAgICBjb25zdCByZXNvbHZlck5hbWUgPSBgJHthcm5QYXJ0c1szXX0uJHthcm5QYXJ0c1s1XX1gO1xuICAgIHJldHVybiBuZXcgUmVzb2x2ZXJIb3Rzd2FwT3BlcmF0aW9uKHJlc29sdmVyTmFtZSwgc2RrQ29tcGF0aWJsZVJlc291cmNlUHJvcGVydGllcyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBGdW5jdGlvbkhvdHN3YXBPcGVyYXRpb24ocmVzb3VyY2VQaHlzaWNhbE5hbWUsIHNka0NvbXBhdGlibGVSZXNvdXJjZVByb3BlcnRpZXMpO1xuICB9XG59XG5cbmNsYXNzIFJlc29sdmVySG90c3dhcE9wZXJhdGlvbiBpbXBsZW1lbnRzIEhvdHN3YXBPcGVyYXRpb24ge1xuICBwdWJsaWMgcmVhZG9ubHkgc2VydmljZSA9ICdhcHBzeW5jJ1xuICBwdWJsaWMgcmVhZG9ubHkgcmVzb3VyY2VOYW1lczogc3RyaW5nW107XG5cbiAgY29uc3RydWN0b3IocmVzb2x2ZXJOYW1lOiBzdHJpbmcsIHByaXZhdGUgcmVhZG9ubHkgdXBkYXRlUmVzb2x2ZXJSZXF1ZXN0OiBBV1MuQXBwU3luYy5VcGRhdGVSZXNvbHZlclJlcXVlc3QpIHtcbiAgICB0aGlzLnJlc291cmNlTmFtZXMgPSBbYEFwcFN5bmMgcmVzb2x2ZXIgJyR7cmVzb2x2ZXJOYW1lfSdgXTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBhcHBseShzZGs6IElTREspOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBzZGsuYXBwc3luYygpLnVwZGF0ZVJlc29sdmVyKHRoaXMudXBkYXRlUmVzb2x2ZXJSZXF1ZXN0KS5wcm9taXNlKCk7XG4gIH1cbn1cblxuY2xhc3MgRnVuY3Rpb25Ib3Rzd2FwT3BlcmF0aW9uIGltcGxlbWVudHMgSG90c3dhcE9wZXJhdGlvbiB7XG4gIHB1YmxpYyByZWFkb25seSBzZXJ2aWNlID0gJ2FwcHN5bmMnXG4gIHB1YmxpYyByZWFkb25seSByZXNvdXJjZU5hbWVzOiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZ1bmN0aW9uTmFtZTogc3RyaW5nLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXBkYXRlRnVuY3Rpb25SZXF1ZXN0OiBPbWl0PEFXUy5BcHBTeW5jLlVwZGF0ZUZ1bmN0aW9uUmVxdWVzdCwgJ2Z1bmN0aW9uSWQnPixcbiAgKSB7XG4gICAgdGhpcy5yZXNvdXJjZU5hbWVzID0gW2BBcHBTeW5jIGZ1bmN0aW9uICcke2Z1bmN0aW9uTmFtZX0nYF07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYXBwbHkoc2RrOiBJU0RLKTogUHJvbWlzZTxhbnk+IHtcbiAgICBjb25zdCB7IGZ1bmN0aW9ucyB9ID0gYXdhaXQgc2RrLmFwcHN5bmMoKS5saXN0RnVuY3Rpb25zKHsgYXBpSWQ6IHRoaXMudXBkYXRlRnVuY3Rpb25SZXF1ZXN0LmFwaUlkIH0pLnByb21pc2UoKTtcbiAgICBjb25zdCB7IGZ1bmN0aW9uSWQgfSA9IGZ1bmN0aW9ucz8uZmluZChmbiA9PiBmbi5uYW1lID09PSB0aGlzLmZ1bmN0aW9uTmFtZSkgPz8ge307XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIC4uLnRoaXMudXBkYXRlRnVuY3Rpb25SZXF1ZXN0LFxuICAgICAgZnVuY3Rpb25JZDogZnVuY3Rpb25JZCEsXG4gICAgfTtcbiAgICByZXR1cm4gc2RrLmFwcHN5bmMoKS51cGRhdGVGdW5jdGlvbihyZXF1ZXN0KS5wcm9taXNlKCk7XG4gIH1cbn1cbiJdfQ==